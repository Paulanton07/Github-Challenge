{% extends 'base.html' %}

{% block title %}{{ project.title }} - CrowdFund{% endblock %}

{% block content %}
<div style="max-width: 800px; margin: 0 auto;">
    <a href="{% url 'project_list' %}" style="color: #3498db; text-decoration: none;">&larr; Back to Projects</a>
    
    <h1 style="margin-top: 1rem;">{{ project.title }}</h1>
    <p style="color: #666;">Created by {{ project.creator.username }}</p>
    
    {% if project.image %}
    <img src="{{ project.image.url }}" alt="{{ project.title }}" style="width: 100%; border-radius: 10px; margin: 1.5rem 0;">
    {% endif %}
    
    <div class="card">
        <h2>Funding Progress</h2>
        <div style="display: flex; align-items: center; gap: 2rem; flex-wrap: wrap;">
            <div style="flex: 0 0 200px;">
                <canvas id="fundingGauge" style="max-width: 200px; max-height: 200px;"></canvas>
            </div>
            <div style="flex: 1; min-width: 200px;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1.5rem;">
                    <div>
                        <h3 style="color: #27ae60; font-size: 1.5rem;">R{{ project.current_funding|floatformat:2 }}</h3>
                        <p style="color: #666; font-size: 0.9rem;">raised of R{{ project.funding_goal|floatformat:2 }}</p>
                    </div>
                    <div>
                        <h3 style="font-size: 1.5rem;">{{ project.total_investors }}</h3>
                        <p style="color: #666; font-size: 0.9rem;">investor(s)</p>
                    </div>
                    <div>
                        <h3 style="font-size: 1.5rem;">{{ days_remaining }}</h3>
                        <p style="color: #666; font-size: 0.9rem;">days remaining</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="card">
        <h2>About This Project</h2>
        <p style="white-space: pre-line;">{{ project.description }}</p>
    </div>
    
    {% if user_investment %}
    <div class="card" style="background: #d4edda; border-left: 4px solid #27ae60;">
        <h3>Your Investment</h3>
        <p><strong>Amount:</strong> R{{ user_investment.amount }}</p>
        <p><strong>Ownership:</strong> {{ user_investment.ownership_percentage|floatformat:4 }}%</p>
        <p><strong>Dividends Earned:</strong> R{{ user_investment.total_dividends_earned }}</p>
    </div>
    {% endif %}
    
    {% if user.is_authenticated and project.is_active %}
    <div class="card">
        <h2>Invest in This Project</h2>
        {% if SANDBOX_MODE %}
        <p style="margin-bottom: 1rem; padding: 0.75rem; background: #fff3cd; border-left: 4px solid #f39c12; border-radius: 5px;">
            ðŸ§ª <strong>SANDBOX MODE</strong> - Mock payment processing (no real money)
        </p>
        {% endif %}
        <form method="post" action="{% url 'make_investment_payment' project.pk %}">
            {% csrf_token %}
            <div style="margin-bottom: 1rem;">
                <label for="amount" style="display: block; margin-bottom: 0.5rem;">Investment Amount (R)</label>
                <input type="number" name="amount" id="amount" step="0.01" min="100" max="50000" required 
                       style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 5px; font-size: 1rem;">
                <small style="color: #666; display: block; margin-top: 0.5rem;">
                    Min: R100 | Max: R50,000 per investment
                </small>
            </div>
            <button type="submit" class="btn" style="width: 100%;">
                {% if SANDBOX_MODE %}Invest Now (Sandbox){% else %}Proceed to Payment{% endif %}
            </button>
        </form>
    </div>
    {% elif not user.is_authenticated %}
    <div class="card" style="text-align: center; background: #fff3cd;">
        <p><a href="{% url 'login' %}" class="btn">Login to Invest</a></p>
    </div>
    {% endif %}
    
    <div class="card">
        <h2>Revenue & Dividends</h2>
        <p><strong>Total Revenue:</strong> R{{ project.total_revenue|floatformat:2 }}</p>
        <p><strong>Distributed:</strong> R{{ project.revenue_distributed|floatformat:2 }}</p>
        <p style="color: #666; margin-top: 1rem;">Dividends are calculated based on your ownership percentage of the project.</p>
    </div>
</div>

{% block scripts %}
<script>
// Funding Gauge - Doughnut Chart styled as gauge
const fundingCtx = document.getElementById('fundingGauge').getContext('2d');
const fundingPercentage = {{ project.funding_percentage|floatformat:2 }};

new Chart(fundingCtx, {
    type: 'doughnut',
    data: {
        datasets: [{
            data: [fundingPercentage, Math.max(0, 100 - fundingPercentage)],
            backgroundColor: [
                fundingPercentage >= 100 ? '#27ae60' : fundingPercentage >= 75 ? '#3498db' : '#f39c12',
                '#ecf0f1'
            ],
            borderWidth: 0,
            circumference: 180,
            rotation: 270
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true,
        cutout: '75%',
        plugins: {
            legend: { display: false },
            tooltip: { enabled: false }
        }
    },
    plugins: [{
        id: 'gaugeText',
        afterDraw: (chart) => {
            const ctx = chart.ctx;
            const width = chart.width;
            const height = chart.height;
            
            ctx.restore();
            ctx.font = 'bold 28px sans-serif';
            ctx.textBaseline = 'middle';
            ctx.fillStyle = '#333';
            
            const text = fundingPercentage.toFixed(0) + '%';
            const textX = Math.round((width - ctx.measureText(text).width) / 2);
            const textY = height / 1.5;
            
            ctx.fillText(text, textX, textY);
            ctx.save();
        }
    }]
});
</script>
{% endblock %}
{% endblock %}

{% extends 'base.html' %}

{% block title %}Dashboard - CrowdFund{% endblock %}

{% block content %}
<h1>Welcome back, {{ user.username }}! ðŸ‘‹</h1>

<div class="stats">
    <div class="stat-card">
        <h3 style="font-size: 2rem;">R{{ total_invested }}</h3>
        <p>Total Invested</p>
    </div>
    <div class="stat-card">
        <h3 style="font-size: 2rem;">{{ projects_backed }}</h3>
        <p>Projects Backed</p>
    </div>
    <div class="stat-card">
        <h3 style="font-size: 2rem;">R{{ total_dividends }}</h3>
        <p>Total Dividends Earned</p>
    </div>
</div>

<!-- Chart Section -->
<div class="chart-section" style="margin-bottom: 3rem;">
    <h2>Visual Analytics</h2>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 2rem; margin-top: 1.5rem;">
        {% if portfolio_amounts %}
        <div class="card">
            <h3 style="margin-bottom: 1rem;">ðŸ’¼ Portfolio Distribution</h3>
            <canvas id="portfolioChart" style="max-height: 300px;"></canvas>
        </div>
        {% endif %}
        
        {% if project_progress %}
        <div class="card">
            <h3 style="margin-bottom: 1rem;">ðŸ“Š Your Projects Funding</h3>
            <canvas id="projectsChart" style="max-height: 300px;"></canvas>
        </div>
        {% endif %}
    </div>
    
    {% if user_investments %}
    <div class="card" style="margin-top: 2rem;">
        <h3 style="margin-bottom: 1rem;">ðŸŽ¯ Investment Performance</h3>
        <canvas id="performanceChart" style="max-height: 250px;"></canvas>
    </div>
    {% endif %}
</div>

<h2>Your Investments</h2>
<div class="grid">
    {% for investment in user_investments %}
    <div class="card">
        <h3>{{ investment.project.title }}</h3>
        <p><strong>Your Investment:</strong> R{{ investment.amount }}</p>
        <p><strong>Ownership:</strong> {{ investment.ownership_percentage|floatformat:4 }}%</p>
        <p><strong>Dividends Earned:</strong> R{{ investment.total_dividends_earned }}</p>
        <p><strong>Status:</strong> {{ investment.get_status_display }}</p>
        <a href="{% url 'project_detail' investment.project.pk %}" class="btn btn-secondary">View Project</a>
    </div>
    {% empty %}
    <p>You haven't made any investments yet. <a href="{% url 'project_list' %}">Browse projects</a> to get started!</p>
    {% endfor %}
</div>

<h2 style="margin-top: 2rem;">Your Projects</h2>
<div class="grid">
    {% for project in user_projects %}
    <div class="card">
        <h3>{{ project.title }}</h3>
        <div class="progress-bar">
            <div class="progress-fill" style="width: {{ project.funding_percentage }}%"></div>
        </div>
        <p><strong>R{{ project.current_funding }} / R{{ project.funding_goal }}</strong></p>
        <p><strong>Status:</strong> {{ project.get_status_display }}</p>
        <p><strong>Investors:</strong> {{ project.total_investors }}</p>
    </div>
    {% empty %}
    <p>You haven't created any projects yet.</p>
    {% endfor %}
</div>
{% endblock %}

{% block scripts %}
<script>
// Chart.js default configuration
Chart.defaults.font.family = "'Segoe UI', Roboto, sans-serif";
Chart.defaults.color = '#666';

{% if portfolio_amounts %}
// Portfolio Distribution - Doughnut Chart
const portfolioCtx = document.getElementById('portfolioChart').getContext('2d');
new Chart(portfolioCtx, {
    type: 'doughnut',
    data: {
        labels: {{ portfolio_labels|safe }},
        datasets: [{
            data: {{ portfolio_amounts|safe }},
            backgroundColor: [
                '#667eea', '#764ba2', '#f093fb', '#4facfe',
                '#43e97b', '#fa709a', '#fee140', '#30cfd0'
            ],
            borderWidth: 2,
            borderColor: '#fff'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
            legend: {
                position: 'bottom',
                labels: { padding: 15, font: { size: 11 } }
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return context.label + ': R' + context.parsed.toFixed(2);
                    }
                }
            }
        }
    }
});
{% endif %}

{% if project_progress %}
// Projects Funding - Bar Chart
const projectsCtx = document.getElementById('projectsChart').getContext('2d');
new Chart(projectsCtx, {
    type: 'bar',
    data: {
        labels: {{ project_names|safe }},
        datasets: [{
            label: 'Current Funding',
            data: {{ project_progress|safe }},
            backgroundColor: '#27ae60',
            borderRadius: 5
        }, {
            label: 'Funding Goal',
            data: {{ project_goals|safe }},
            backgroundColor: '#ecf0f1',
            borderRadius: 5
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true,
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    callback: function(value) {
                        return 'R' + value.toLocaleString();
                    }
                }
            }
        },
        plugins: {
            legend: { position: 'top' },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return context.dataset.label + ': R' + context.parsed.y.toFixed(2);
                    }
                }
            }
        }
    }
});
{% endif %}

{% if user_investments %}
// Investment Performance - Horizontal Bar Chart
const performanceCtx = document.getElementById('performanceChart').getContext('2d');
new Chart(performanceCtx, {
    type: 'bar',
    data: {
        labels: [{% for inv in user_investments %}'{{ inv.project.title|truncatechars:20|escapejs }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
        datasets: [{
            label: 'Investment Amount',
            data: [{% for inv in user_investments %}{{ inv.amount }}{% if not forloop.last %}, {% endif %}{% endfor %}],
            backgroundColor: '#3498db',
            borderRadius: 5
        }, {
            label: 'Dividends Earned',
            data: [{% for inv in user_investments %}{{ inv.total_dividends_earned }}{% if not forloop.last %}, {% endif %}{% endfor %}],
            backgroundColor: '#27ae60',
            borderRadius: 5
        }]
    },
    options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: true,
        scales: {
            x: {
                beginAtZero: true,
                ticks: {
                    callback: function(value) {
                        return 'R' + value.toLocaleString();
                    }
                }
            }
        },
        plugins: {
            legend: { position: 'top' },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return context.dataset.label + ': R' + context.parsed.x.toFixed(2);
                    }
                }
            }
        }
    }
});
{% endif %}
</script>
{% endblock %}
